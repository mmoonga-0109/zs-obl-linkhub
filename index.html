<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zambia Sugar Outbound Logistics Link Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Feather Icons for UI icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Simple animation for link cards appearing */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .link-card {
            animation: fadeIn 0.4s ease-out forwards;
        }
        /* Animation for modal */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content {
            animation: modalFadeIn 0.2s ease-out forwards;
        }
        /* Ensure grid rows have equal height cards */
        #linksContainer {
            grid-auto-rows: 1fr;
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Main container for the application -->
    <div class="w-full max-w-6xl mx-auto p-4 md:p-8">
        <div class="rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
            
            <!-- Sticky Header Wrapper -->
            <div class="sticky top-0 z-10 bg-white px-6 md:px-8 pt-6 pb-6 border-b border-slate-200">
                <!-- Header Section -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                         <h1 class="text-2xl md:text-3xl font-extrabold text-slate-800">Zambia Sugar Outbound Logistics Link Hub</h1>
                    </div>
                    <button id="openAddLinkModalBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center shadow-sm hover:shadow-md flex-shrink-0">
                        <i data-feather="plus" class="w-5 h-5 mr-1"></i>
                        Add New Link
                    </button>
                </div>

                <!-- Search Bar -->
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-4">
                        <i data-feather="search" class="w-5 h-5 text-slate-400"></i>
                    </span>
                    <input type="text" id="searchInput" placeholder="Search by title, category, or description..." class="w-full pl-12 pr-4 py-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
            </div>

            <!-- Scrollable Content Area -->
            <div class="px-6 md:px-8 py-8 bg-slate-50">
                <!-- Welcome Message -->
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold text-slate-800">Welcome to the Outbound Logistics Link Hub</h2>
                    <p class="text-slate-500 mt-1">Select a tile to get started.</p>
                </div>

                <!-- Links Display Section -->
                <div>
                    <!-- Container for the list of links -->
                    <div id="linksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Links will be dynamically inserted here -->
                        <div id="loadingState" class="text-center py-8 col-span-full">
                            <p class="text-slate-500">Loading links...</p>
                        </div>
                    </div>
                    <!-- "No results" message -->
                    <p id="noResults" class="text-slate-500 text-center py-8 hidden">No links match your search.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Add/Edit Link Modal -->
    <div id="linkModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-content bg-white rounded-2xl shadow-xl p-8 w-full max-w-md relative">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
            <h2 id="modalTitle" class="text-2xl font-bold text-slate-900 mb-6">Add a New Link</h2>
            <form id="linkForm">
                <input type="hidden" id="linkId">
                <div class="space-y-4">
                    <div>
                        <label for="linkTitle" class="block text-sm font-medium text-slate-600 mb-1">Title</label>
                        <input type="text" id="linkTitle" name="linkTitle" required placeholder="e.g., Action Tracker" class="w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="linkUrl" class="block text-sm font-medium text-slate-600 mb-1">URL</label>
                        <input type="url" id="linkUrl" name="linkUrl" required placeholder="https://..." class="w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="linkCategory" class="block text-sm font-medium text-slate-600 mb-1">Category</label>
                        <input type="text" id="linkCategory" name="linkCategory" required placeholder="e.g., Collaboration & Planning" class="w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label for="linkDescription" class="block text-sm font-medium text-slate-600 mb-1">Description</label>
                        <textarea id="linkDescription" name="linkDescription" rows="3" required placeholder="A short description of the link..." class="w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition"></textarea>
                    </div>
                    <button type="submit" id="modalSubmitBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out flex items-center justify-center">
                        Add Link
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Import necessary functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, doc, updateDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration and Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-link-hub';
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let allLinks = []; // Cache for all links to enable client-side search

        // --- Main Application Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Improved check for Firebase configuration
                if (!firebaseConfigString) {
                    throw new Error("Firebase configuration is missing. Cannot connect to the service.");
                }
                const firebaseConfig = JSON.parse(firebaseConfigString);

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await addDummyDataIfNeeded(); // Add dummy data if collection is empty
                        setupRealtimeListener();
                    }
                });

                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
                else { await signInAnonymously(auth); }

                setupEventListeners();
                feather.replace();

            } catch (error) {
                console.error("Initialization Error:", error.message);
                const linksContainer = document.getElementById('linksContainer');
                if (linksContainer) {
                    linksContainer.innerHTML = `<p class="text-red-500 text-center col-span-full">Error connecting to the service. Please check the console for more details.</p>`;
                }
            }
        });
        
        function setupEventListeners() {
            const linkForm = document.getElementById('linkForm');
            const openModalBtn = document.getElementById('openAddLinkModalBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modal = document.getElementById('linkModal');
            const searchInput = document.getElementById('searchInput');

            linkForm.addEventListener('submit', handleFormSubmit);
            openModalBtn.addEventListener('click', openAddModal);
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
            searchInput.addEventListener('input', handleSearch);
        }

        function setupRealtimeListener() {
            const linksCollectionPath = `/artifacts/${appId}/public/data/links`;
            const q = query(collection(db, linksCollectionPath));

            onSnapshot(q, (querySnapshot) => {
                allLinks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayLinks(allLinks);
            }, (error) => {
                console.error("Error fetching links:", error);
                document.getElementById('linksContainer').innerHTML = `<p class="text-red-500 text-center col-span-full">Error fetching links.</p>`;
            });
        }

        function displayLinks(links) {
            const linksContainer = document.getElementById('linksContainer');
            linksContainer.innerHTML = ''; // Clear existing links
            const loadingState = document.getElementById('loadingState');
            if(loadingState) loadingState.remove();

            if (links.length === 0) {
                linksContainer.innerHTML = `<p class="text-slate-500 text-center py-8 col-span-full">No links have been added yet. Be the first!</p>`;
            } else {
                links.forEach(link => {
                    const linkElement = createLinkElement(link);
                    linksContainer.appendChild(linkElement);
                });
            }
            feather.replace();
        }

        function createLinkElement({ id, title, url, category, description }) {
            const card = document.createElement('div');
            card.className = 'link-card bg-white p-6 rounded-xl border border-slate-200 flex flex-col hover:shadow-lg transition-shadow duration-300';
            card.dataset.searchText = `${title} ${category} ${description}`.toLowerCase();

            let safeUrl = url.startsWith('http') ? url : `https://` + url;
            const TRUNCATE_LENGTH = 120;
            let isTruncated = description.length > TRUNCATE_LENGTH;
            
            let displayDescription = isTruncated ? description.substring(0, TRUNCATE_LENGTH) + '...' : description;
            let moreLinkHTML = isTruncated ? `<a href="#" class="more-less-btn text-slate-500 font-semibold text-sm hover:text-slate-800">more</a>` : '';

            card.innerHTML = `
                <div class="flex-grow">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-slate-800">${title}</h3>
                        <div class="flex items-center space-x-3">
                            <button class="edit-btn text-slate-400 hover:text-indigo-600" data-id="${id}"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                            <button class="delete-btn text-slate-400 hover:text-red-500" data-id="${id}"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <p class="text-sm font-medium text-blue-600 mb-3">${category}</p>
                    <p class="description-text text-slate-500 text-sm leading-relaxed">${displayDescription}</p>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="inline-block text-indigo-600 font-semibold text-sm hover:text-indigo-800">
                        Open Link &rarr;
                    </a>
                    ${moreLinkHTML}
                </div>
            `;

            card.querySelector('.delete-btn').addEventListener('click', () => handleDeleteLink(id));
            card.querySelector('.edit-btn').addEventListener('click', () => openEditModal(id));
            
            if (isTruncated) {
                const moreBtn = card.querySelector('.more-less-btn');
                const descriptionP = card.querySelector('.description-text');
                let isExpanded = false;
                moreBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    isExpanded = !isExpanded;
                    descriptionP.textContent = isExpanded ? description : displayDescription;
                    moreBtn.textContent = isExpanded ? 'less' : 'more';
                });
            }

            return card;
        }

        function openAddModal() {
            const modal = document.getElementById('linkModal');
            document.getElementById('linkForm').reset();
            document.getElementById('linkId').value = '';
            document.getElementById('modalTitle').textContent = 'Add a New Link';
            document.getElementById('modalSubmitBtn').textContent = 'Add Link';
            modal.classList.remove('hidden');
            feather.replace();
        }

        async function openEditModal(id) {
            const linkDocPath = `/artifacts/${appId}/public/data/links/${id}`;
            const docSnap = await getDoc(doc(db, linkDocPath));
            if (docSnap.exists()) {
                const link = docSnap.data();
                document.getElementById('linkId').value = id;
                document.getElementById('linkTitle').value = link.title;
                document.getElementById('linkUrl').value = link.url;
                document.getElementById('linkCategory').value = link.category;
                document.getElementById('linkDescription').value = link.description;
                
                document.getElementById('modalTitle').textContent = 'Edit Link';
                document.getElementById('modalSubmitBtn').textContent = 'Save Changes';
                document.getElementById('linkModal').classList.remove('hidden');
                feather.replace();
            }
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            const linkId = document.getElementById('linkId').value;
            const linkData = {
                title: document.getElementById('linkTitle').value.trim(),
                url: document.getElementById('linkUrl').value.trim(),
                category: document.getElementById('linkCategory').value.trim(),
                description: document.getElementById('linkDescription').value.trim(),
            };

            try {
                if (linkId) { // Editing existing link
                    const linkDocPath = `/artifacts/${appId}/public/data/links/${linkId}`;
                    await updateDoc(doc(db, linkDocPath), linkData);
                } else { // Adding new link
                    linkData.createdAt = serverTimestamp();
                    const linksCollectionPath = `/artifacts/${appId}/public/data/links`;
                    await addDoc(collection(db, linksCollectionPath), linkData);
                }
                document.getElementById('linkModal').classList.add('hidden');
            } catch (error) {
                console.error("Error saving link: ", error);
            }
        }

        async function handleDeleteLink(id) {
            if (window.confirm('Are you sure you want to delete this link?')) {
                try {
                    const linkDocPath = `/artifacts/${appId}/public/data/links/${id}`;
                    await deleteDoc(doc(db, linkDocPath));
                } catch (error) {
                    console.error("Error deleting link: ", error);
                }
            }
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredLinks = allLinks.filter(link => {
                const searchText = `${link.title} ${link.category} ${link.description}`.toLowerCase();
                return searchText.includes(searchTerm);
            });
            displayLinks(filteredLinks);
            
            const noResultsMessage = document.getElementById('noResults');
            noResultsMessage.style.display = filteredLinks.length === 0 && allLinks.length > 0 ? 'block' : 'hidden';
        }

        /**
         * Checks if the links collection is empty and adds dummy data if it is.
         */
        async function addDummyDataIfNeeded() {
            const linksCollectionPath = `/artifacts/${appId}/public/data/links`;
            const linksCollection = collection(db, linksCollectionPath);
            const snapshot = await getDocs(linksCollection);
            
            if (snapshot.empty) {
                console.log('No links found. Adding dummy data...');
                const dummyLinks = [
                    {
                        title: "SC Outbound Logistics Action Tracker",
                        category: "Collaboration & Planning",
                        description: "Welcome to our team's action tracker! This is our shared space to manage commitments and track progress on key logistics initiatives.",
                        url: "#"
                    },
                    {
                        title: "Daily Warehouse Productivity Report",
                        category: "Performance Management",
                        description: "This interactive report is designed to drive operational excellence across our warehouse operations. It includes detailed metrics on receiving, put-away, picking, and shipping activities. Use this data to identify bottlenecks, improve workflow efficiency, and recognize top-performing teams. The report is updated every morning at 6 AM.",
                        url: "#"
                    },
                    {
                        title: "Warehouse Capacity Simulation",
                        category: "Logistics & Operations Planning",
                        description: "A strategic planning tool designed to optimise our sugar warehousing and distribution network. This simulation allows us to model different scenarios, such as changes in demand, new storage facilities, or shifts in transportation routes. It is a critical tool for long-term strategic planning and ensuring we can meet future market demands efficiently and cost-effectively. Please consult the user guide before running new simulations.",
                        url: "#"
                    },
                    {
                        title: "Standard Operating Procedures (SOP)",
                        category: "Quality & Compliance",
                        description: "This serves as the central repository for all approved Standard Operating Procedures related to outbound logistics.",
                        url: "#"
                    },
                    {
                        title: "Document Archive",
                        category: "Records Management",
                        description: "This folder is the official Document Archive. It is intended for the long-term storage of documents that are no longer in active daily use.",
                        url: "#"
                    },
                    {
                        title: "Weekly Safety Meeting Minutes",
                        category: "Safety & Compliance",
                        description: "Access minutes and action items from our weekly safety stand-up meetings to stay informed on safety protocols.",
                        url: "#"
                    },
                    {
                        title: "Vehicle Maintenance Schedule",
                        category: "Fleet Management",
                        description: "Live schedule for all planned and completed maintenance on our logistics fleet. Keep track of vehicle availability.",
                        url: "#"
                    },
                    {
                        title: "Supplier Contact List",
                        category: "Vendor Management",
                        description: "An up-to-date directory of all our key logistics suppliers, carriers, and service providers.",
                        url: "#"
                    }
                ];

                for (const link of dummyLinks) {
                    await addDoc(linksCollection, { ...link, createdAt: serverTimestamp() });
                }
            }
        }
    </script>
</body>
</html>
